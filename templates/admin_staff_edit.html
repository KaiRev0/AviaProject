{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞{% endblock %}

{% block content %}
<div class="dashboard admin-dashboard">
    <div class="admin-header-with-actions">
        <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
        <div class="header-actions">
            <a href="/admin/staff" class="btn back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        </div>
    </div>
    
    <div class="edit-form-container">
        <form method="POST" class="edit-form">
            <div class="form-section">
                <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω:*</label>
                        <input type="text" id="phone" name="phone" 
                               value="{{ staff.phone }}" required>
                        <small>–§–æ—Ä–º–∞—Ç: +7XXX –∏–ª–∏ 8XXX</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="role">–†–æ–ª—å:*</label>
                        <select id="role" name="role" class="form-control" required
                                onchange="toggleOrganizationField()">
                            <option value="admin" {{ 'selected' if staff.role == 'admin' else '' }}>
                                üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                            </option>
                            <option value="cashier" {{ 'selected' if staff.role == 'cashier' else '' }}>
                                üíº –ö–∞—Å—Å–∏—Ä
                            </option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>–ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="passport_series">–°–µ—Ä–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞:*</label>
                        <input type="text" id="passport_series" name="passport_series" 
                               value="{{ staff.passport_series }}" maxlength="4" required>
                        <small>4 —Ü–∏—Ñ—Ä—ã</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="passport_number">–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞:*</label>
                        <input type="text" id="passport_number" name="passport_number" 
                               value="{{ staff.passport_number }}" maxlength="6" required>
                        <small>6 —Ü–∏—Ñ—Ä</small>
                    </div>
                </div>
            </div>
            
            <div class="form-section" id="organization-section" 
                 style="{{ 'display: block;' if staff.role == 'cashier' else 'display: none;' }}">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="organization_number">–ù–æ–º–µ—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:*</label>
                        <input type="text" id="organization_number" name="organization_number" 
                               value="{{ staff.organization_number or '' }}"
                               {{ 'required' if staff.role == 'cashier' else '' }}>
                        <small>5-15 —Ü–∏—Ñ—Ä</small>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>–°—Ç–∞—Ç—É—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
            </div>
            
            <div class="info-box">
                <h4>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ:</h4>
                <div class="staff-info-grid">
                    <div class="info-item">
                        <span class="label">ID:</span>
                        <span class="value">{{ staff.id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
                        <span class="value">{{ staff.created_at[:19] if staff.created_at else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</span>
                        <span class="value">
                            {% if staff.last_login %}
                                {{ staff.last_login[:19] }}
                            {% else %}
                                –ù–∏–∫–æ–≥–¥–∞
                            {% endif %}
                        </span>
                    </div>
                    {% if staff.role == 'cashier' %}
                    <div class="info-item">
                        <span class="label">–°–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ä–µ–π—Å–æ–≤:</span>
                        <span class="value">
                            <a href="/admin/flights?created_by={{ staff.id }}">
                                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–π—Å—ã
                            </a>
                        </span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="warning-box" style="{{ 'display: block;' if staff.id == session.user_id else 'display: none;' }}">
                    <p>‚ö†Ô∏è <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –í—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç–µ —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å.</p>
                    <p>–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –≤—Å—Ç—É–ø–∏—Ç—å –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞.</p>
                </div>
            </div>
            
            <div class="form-buttons">
                <button type="submit" class="btn save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button type="reset" class="btn reset-btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <a href="/admin/staff" class="btn cancel-btn">–û—Ç–º–µ–Ω–∞</a>
                
                {% if staff.id != session.user_id %}
                <a href="/admin/staff/delete/{{ staff.id }}" 
                   class="btn delete-btn"
                   onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ {{ staff.phone }}?')">
                    –£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<script>
function toggleOrganizationField() {
    const role = document.getElementById('role').value;
    const orgSection = document.getElementById('organization-section');
    const orgInput = document.getElementById('organization_number');
    
    if (role === 'cashier') {
        orgSection.style.display = 'block';
        orgInput.required = true;
    } else {
        orgSection.style.display = 'none';
        orgInput.required = false;
        orgInput.value = '';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    toggleOrganizationField();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('blur', function() {
        const phone = this.value;
        const phoneRegex = /^(\+7|8)[\s\-]?\(?\d{3}\)?[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}$/;
        
        if (phone && !phoneRegex.test(phone)) {
            this.style.borderColor = '#f44336';
        } else {
            this.style.borderColor = '';
        }
    });
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Å–ø–æ—Ä—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    const passportSeries = document.getElementById('passport_series');
    const passportNumber = document.getElementById('passport_number');
    
    passportSeries.addEventListener('blur', function() {
        const series = this.value;
        if (series && (!/^\d{4}$/.test(series))) {
            this.style.borderColor = '#f44336';
        } else {
            this.style.borderColor = '';
        }
    });
    
    passportNumber.addEventListener('blur', function() {
        const number = this.value;
        if (number && (!/^\d{6}$/.test(number))) {
            this.style.borderColor = '#f44336';
        } else {
            this.style.borderColor = '';
        }
    });
});
</script>

<style>
.staff-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: white;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
}

.info-item .label {
    color: #666;
    font-weight: 500;
}

.info-item .value {
    color: #1976d2;
    font-weight: 500;
}

.info-item a {
    color: #1976d2;
    text-decoration: none;
}

.info-item a:hover {
    text-decoration: underline;
}

.warning-box {
    background: #fff3e0;
    border-left: 4px solid #ff9800;
    padding: 15px;
    border-radius: 6px;
    margin-top: 20px;
}

.warning-box p {
    margin: 5px 0;
    color: #ef6c00;
}

.delete-btn {
    background: #f44336 !important;
    color: white !important;
}

.delete-btn:hover {
    background: #d32f2f !important;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.warning-box {
    animation: pulse 2s infinite;
}

@media (max-width: 768px) {
    .staff-info-grid {
        grid-template-columns: 1fr;
    }
    
    .form-buttons {
        flex-direction: column;
    }
    
    .form-buttons a,
    .form-buttons button {
        width: 100%;
    }
}
</style>
{% endblock %}